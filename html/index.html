<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅游搭子平台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 16px;
        }

        header {
            background: #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .site-title {
            font-size: 24px;
            font-weight: bold;
            color: #2c5282;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        select, button {
            padding: 8px 16px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            background: #fff;
            cursor: pointer;
            font-size: 14px;
        }

        button {
            background: #3182ce;
            color: #fff;
            border: none;
            transition: background 0.2s;
        }

        button:hover {
            background: #2c5282;
        }

        button.secondary {
            background: #718096;
        }

        button.secondary:hover {
            background: #4a5568;
        }

        button.danger {
            background: #e53e3e;
        }

        button.danger:hover {
            background: #c53030;
        }

        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        nav {
            background: #fff;
            border-bottom: 2px solid #e2e8f0;
            margin-top: 16px;
        }

        .nav-tabs {
            display: flex;
            gap: 4px;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #4a5568;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            white-space: nowrap;
        }

        .nav-tab.active {
            color: #3182ce;
            border-bottom-color: #3182ce;
        }

        .view {
            display: none;
            padding: 24px 0;
        }

        .view.active {
            display: block;
        }

        .card {
            background: #fff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2d3748;
        }

        .card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin: 12px 0;
            font-size: 14px;
            color: #718096;
        }

        .card-meta-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 12px 0;
        }

        .tag {
            padding: 4px 12px;
            background: #e6fffa;
            color: #234e52;
            border-radius: 16px;
            font-size: 12px;
        }

        .tag.budget {
            background: #fef5e7;
            color: #7c2d12;
        }

        .tag.constraint {
            background: #fef5e7;
            color: #7c2d12;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #2d3748;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }

        .checkbox-group,
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-item,
        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .error {
            color: #e53e3e;
            font-size: 12px;
            margin-top: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .filters {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .trip-list {
            display: grid;
            gap: 16px;
        }

        .trip-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .trip-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: flex-start;
            justify-content: center;
        }

        .modal-content {
            background: #fff;
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            width: 100%;
            margin: 40px auto;
            max-height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #718096;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .member-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 12px 0;
        }

        .member-badge {
            padding: 6px 12px;
            background: #ebf8ff;
            color: #2c5282;
            border-radius: 16px;
            font-size: 13px;
        }

        .application-item {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .application-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .application-actions {
            display: flex;
            gap: 8px;
        }

        .version-item {
            border-left: 3px solid #3182ce;
            padding: 12px;
            background: #f7fafc;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .version-content {
            font-size: 14px;
            color: #4a5568;
            line-height: 1.6;
        }

        .confirmation-list {
            margin-top: 8px;
            font-size: 13px;
        }

        .confirmation-item {
            display: inline-block;
            margin-right: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .confirmation-item.agree {
            background: #c6f6d5;
            color: #22543d;
        }

        .confirmation-item.disagree {
            background: #fed7d7;
            color: #742a2a;
        }

        .confirmation-item.pending {
            background: #feebc8;
            color: #7c2d12;
        }

        .ledger-item {
            border: 1px solid #e2e8f0;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .ledger-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .settlement-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .settlement-table th,
        .settlement-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .settlement-table th {
            background: #f7fafc;
            font-weight: 600;
        }

        .amount-positive {
            color: #38a169;
        }

        .amount-negative {
            color: #e53e3e;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-recruiting {
            background: #bee3f8;
            color: #2c5282;
        }

        .status-confirmed {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-finished {
            background: #e2e8f0;
            color: #4a5568;
        }

        .status-pending {
            background: #feebc8;
            color: #7c2d12;
        }

        .status-approved {
            background: #c6f6d5;
            color: #22543d;
        }

        .status-rejected {
            background: #fed7d7;
            color: #742a2a;
        }

        .rating-form {
            margin-top: 16px;
        }

        .rating-item {
            margin-bottom: 12px;
        }

        .rating-stars {
            display: flex;
            gap: 4px;
        }

        .star {
            cursor: pointer;
            font-size: 24px;
            color: #cbd5e0;
        }

        .star.active {
            color: #f6ad55;
        }

        .inbox-item {
            border-left: 3px solid #3182ce;
            padding: 12px;
            background: #f7fafc;
            margin-bottom: 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .inbox-item:hover {
            background: #edf2f7;
        }

        .profile-section {
            margin-bottom: 24px;
        }

        .blacklist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f7fafc;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .section-divider {
            border: 0;
            border-top: 1px solid #e2e8f0;
            margin: 24px 0;
        }

        .detail-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .detail-label {
            font-weight: 600;
            min-width: 100px;
            color: #4a5568;
        }

        .detail-value {
            color: #2d3748;
        }

        .collapsible {
            margin-top: 16px;
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f7fafc;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .collapsible-content {
            display: none;
            padding: 12px;
        }

        .collapsible-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }

            .site-title {
                font-size: 20px;
            }

            .nav-tab {
                padding: 10px 16px;
                font-size: 14px;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                margin: 20px auto;
            }

            .card-meta {
                flex-direction: column;
                gap: 6px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="site-title">旅游搭子平台</div>
                <div class="header-actions">
                    <select id="userSelect" onchange="switchUser()">
                        <option value="u1">阿林 (已实名)</option>
                        <option value="u2">小周 (未实名)</option>
                        <option value="u3">Mika (已实名)</option>
                    </select>
                    <button onclick="resetData()" class="secondary">重置示例数据</button>
                </div>
            </div>
        </div>
    </header>

    <nav>
        <div class="container">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="switchTab('trips')">发现</button>
                <button class="nav-tab" onclick="switchTab('create')">发布</button>
                <button class="nav-tab" onclick="switchTab('inbox')">消息/申请</button>
                <button class="nav-tab" onclick="switchTab('profile')">我的</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- 发现页 -->
        <div id="trips-view" class="view active">
            <div class="filters card">
                <h3 style="margin-bottom: 16px;">筛选</h3>
                <div class="filters-grid">
                    <div class="form-group">
                        <label>目的地关键词</label>
                        <input type="text" id="filter-destination" placeholder="输入目的地">
                    </div>
                    <div class="form-group">
                        <label>开始日期</label>
                        <input type="date" id="filter-start-date">
                    </div>
                    <div class="form-group">
                        <label>结束日期</label>
                        <input type="date" id="filter-end-date">
                    </div>
                    <div class="form-group">
                        <label>预算档位</label>
                        <select id="filter-budget">
                            <option value="">全部</option>
                            <option value="经济">经济</option>
                            <option value="舒适">舒适</option>
                            <option value="轻奢">轻奢</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>风格标签（多选）</label>
                    <div class="checkbox-group" id="filter-styles"></div>
                </div>
                <div class="form-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="filter-verified">
                        <label for="filter-verified" style="margin: 0;">仅看需要实名的行程</label>
                    </div>
                </div>
                <button onclick="applyFilters()">应用筛选</button>
            </div>
            <div id="trip-list" class="trip-list"></div>
        </div>

        <!-- 发布页 -->
        <div id="create-view" class="view">
            <div class="card">
                <h2 class="card-title">发布新行程</h2>
                <form id="create-trip-form" onsubmit="createTrip(event)">
                    <div class="form-group">
                        <label>标题 *</label>
                        <input type="text" name="title" required>
                    </div>
                    <div class="form-group">
                        <label>出发地 *</label>
                        <input type="text" name="from" required>
                    </div>
                    <div class="form-group">
                        <label>目的地 *</label>
                        <input type="text" name="to" required>
                    </div>
                    <div class="form-group">
                        <label>开始日期 *</label>
                        <input type="date" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label>结束日期 *</label>
                        <input type="date" name="endDate" required>
                    </div>
                    <div class="form-group">
                        <label>人数上限 * (至少2人)</label>
                        <input type="number" name="maxMembers" min="2" required>
                    </div>
                    <div class="form-group">
                        <label>预算档位 *</label>
                        <select name="budgetTier" required>
                            <option value="经济">经济</option>
                            <option value="舒适">舒适</option>
                            <option value="轻奢">轻奢</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>风格标签（多选）</label>
                        <div class="checkbox-group" id="create-styles"></div>
                    </div>
                    <div class="form-group">
                        <label>费用模式 *</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" name="costMode" value="PURE_AA" id="cost-pure-aa" required>
                                <label for="cost-pure-aa" style="margin: 0;">纯AA</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="costMode" value="HOST_BOOKING_AA" id="cost-host-aa" checked>
                                <label for="cost-host-aa" style="margin: 0;">发起人代订+AA</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" name="costMode" value="SEPARATE_BOOKING" id="cost-separate">
                                <label for="cost-separate" style="margin: 0;">各自预订（不拼房）</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>硬约束（多选）</label>
                        <div class="checkbox-group" id="create-constraints"></div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="requireVerified" id="require-verified">
                            <label for="require-verified" style="margin: 0;">仅实名用户可申请</label>
                        </div>
                    </div>
                    <hr class="section-divider">
                    <h3>关键约定（V1版本）</h3>
                    <div class="form-group">
                        <label>集合点/时间</label>
                        <input type="text" name="meetup" placeholder="例如：北京西站南广场 8:00">
                    </div>
                    <div class="form-group">
                        <label>住宿规则</label>
                        <textarea name="lodging" placeholder="例如：两人一间，费用AA"></textarea>
                    </div>
                    <div class="form-group">
                        <label>费用规则</label>
                        <textarea name="costRules" placeholder="例如：门票、交通、餐饮各自负担后AA"></textarea>
                    </div>
                    <div class="form-group">
                        <label>取消规则</label>
                        <textarea name="cancelRule" placeholder="例如：出发前3天取消全额退款"></textarea>
                    </div>
                    <button type="submit">发布行程</button>
                </form>
            </div>
        </div>

        <!-- 消息/申请页 -->
        <div id="inbox-view" class="view">
            <div class="card">
                <h2 class="card-title">消息与申请</h2>
                <div id="inbox-list"></div>
            </div>
        </div>

        <!-- 我的页 -->
        <div id="profile-view" class="view">
            <div class="card">
                <h2 class="card-title">个人信息</h2>
                <div id="profile-info"></div>
            </div>
            <div class="card">
                <h2 class="card-title">我的行程</h2>
                <div id="my-trips"></div>
            </div>
        </div>
    </div>

    <!-- 行程详情模态框 -->
    <div id="trip-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">行程详情</h2>
                <button class="close-btn" onclick="closeModal('trip-detail-modal')">&times;</button>
            </div>
            <div id="trip-detail-content"></div>
        </div>
    </div>

    <!-- 申请加入模态框 -->
    <div id="apply-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">申请加入</h2>
                <button class="close-btn" onclick="closeModal('apply-modal')">&times;</button>
            </div>
            <form id="apply-form" onsubmit="submitApplication(event)">
                <input type="hidden" name="tripId">
                <div class="form-group">
                    <label>预算区间 *</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="budget" value="经济" id="apply-budget-eco" required>
                            <label for="apply-budget-eco" style="margin: 0;">经济</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="budget" value="舒适" id="apply-budget-comfort">
                            <label for="apply-budget-comfort" style="margin: 0;">舒适</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="budget" value="轻奢" id="apply-budget-luxury">
                            <label for="apply-budget-luxury" style="margin: 0;">轻奢</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>节奏 *</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="pace" value="特种兵" id="apply-pace-fast" required>
                            <label for="apply-pace-fast" style="margin: 0;">特种兵</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="pace" value="均衡" id="apply-pace-balanced">
                            <label for="apply-pace-balanced" style="margin: 0;">均衡</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="pace" value="慢游" id="apply-pace-slow">
                            <label for="apply-pace-slow" style="margin: 0;">慢游</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>作息 *</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="schedule" value="早起" id="apply-schedule-early" required>
                            <label for="apply-schedule-early" style="margin: 0;">早起</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="schedule" value="随缘" id="apply-schedule-flexible">
                            <label for="apply-schedule-flexible" style="margin: 0;">随缘</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="schedule" value="夜猫" id="apply-schedule-night">
                            <label for="apply-schedule-night" style="margin: 0;">夜猫</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>可接受（多选）</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="acceptable" value="拼房" id="apply-accept-share">
                            <label for="apply-accept-share" style="margin: 0;">拼房</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="acceptable" value="AA" id="apply-accept-aa">
                            <label for="apply-accept-aa" style="margin: 0;">AA</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="acceptable" value="代订" id="apply-accept-booking">
                            <label for="apply-accept-booking" style="margin: 0;">代订</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>最介意（多选）</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="concerns" value="迟到" id="apply-concern-late">
                            <label for="apply-concern-late" style="margin: 0;">迟到</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="concerns" value="抽烟" id="apply-concern-smoke">
                            <label for="apply-concern-smoke" style="margin: 0;">抽烟</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="concerns" value="临时加价" id="apply-concern-price">
                            <label for="apply-concern-price" style="margin: 0;">临时加价</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="concerns" value="频繁改行程" id="apply-concern-change">
                            <label for="apply-concern-change" style="margin: 0;">频繁改行程</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="concerns" value="拍照太久" id="apply-concern-photo">
                            <label for="apply-concern-photo" style="margin: 0;">拍照太久</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="concerns" value="夜生活" id="apply-concern-night">
                            <label for="apply-concern-night" style="margin: 0;">夜生活</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="concerns" value="其他" id="apply-concern-other">
                            <label for="apply-concern-other" style="margin: 0;">其他</label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>自我介绍（选填，限200字）</label>
                    <textarea name="intro" maxlength="200" placeholder="简单介绍一下自己..."></textarea>
                </div>
                <button type="submit">提交申请</button>
            </form>
        </div>
    </div>

    <!-- 发布新版本模态框 -->
    <div id="new-version-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">发布新版本</h2>
                <button class="close-btn" onclick="closeModal('new-version-modal')">&times;</button>
            </div>
            <form id="new-version-form" onsubmit="publishNewVersion(event)">
                <input type="hidden" name="tripId">
                <div class="form-group">
                    <label>集合点/时间</label>
                    <input type="text" name="meetup" required>
                </div>
                <div class="form-group">
                    <label>住宿规则</label>
                    <textarea name="lodging" required></textarea>
                </div>
                <div class="form-group">
                    <label>费用规则</label>
                    <textarea name="costRules" required></textarea>
                </div>
                <div class="form-group">
                    <label>取消规则</label>
                    <textarea name="cancelRule" required></textarea>
                </div>
                <button type="submit">发布新版本</button>
            </form>
        </div>
    </div>

    <!-- 新增费用模态框 -->
    <div id="add-expense-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">新增费用</h2>
                <button class="close-btn" onclick="closeModal('add-expense-modal')">&times;</button>
            </div>
            <form id="add-expense-form" onsubmit="addExpense(event)">
                <input type="hidden" name="tripId">
                <div class="form-group">
                    <label>类型 *</label>
                    <select name="type" required>
                        <option value="TRANSPORT">交通</option>
                        <option value="LODGING">住宿</option>
                        <option value="FOOD">餐饮</option>
                        <option value="TICKET">门票</option>
                        <option value="OTHER">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>标题 *</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>金额 * (元)</label>
                    <input type="number" name="amount" min="0.01" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>付款人 *</label>
                    <select name="paidBy" id="expense-paidby" required></select>
                </div>
                <div class="form-group">
                    <label>分摊方式 *</label>
                    <select name="split" required>
                        <option value="EQUAL">均分</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>参与者（多选）</label>
                    <div class="checkbox-group" id="expense-participants"></div>
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <textarea name="note"></textarea>
                </div>
                <button type="submit">添加费用</button>
            </form>
        </div>
    </div>

    <!-- 编辑费用模态框 -->
    <div id="edit-expense-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">编辑费用</h2>
                <button class="close-btn" onclick="closeModal('edit-expense-modal')">&times;</button>
            </div>
            <form id="edit-expense-form" onsubmit="submitExpenseChange(event)">
                <input type="hidden" name="tripId">
                <input type="hidden" name="itemId">
                <input type="hidden" name="action" value="UPDATE">
                <div class="form-group">
                    <label>类型 *</label>
                    <select name="type" required>
                        <option value="TRANSPORT">交通</option>
                        <option value="LODGING">住宿</option>
                        <option value="FOOD">餐饮</option>
                        <option value="TICKET">门票</option>
                        <option value="OTHER">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>标题 *</label>
                    <input type="text" name="title" required>
                </div>
                <div class="form-group">
                    <label>金额 * (元)</label>
                    <input type="number" name="amount" min="0.01" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>付款人 *</label>
                    <select name="paidBy" id="edit-expense-paidby" required></select>
                </div>
                <div class="form-group">
                    <label>分摊方式 *</label>
                    <select name="split" required>
                        <option value="EQUAL">均分</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>参与者（多选）</label>
                    <div class="checkbox-group" id="edit-expense-participants"></div>
                </div>
                <div class="form-group">
                    <label>备注</label>
                    <textarea name="note"></textarea>
                </div>
                <button type="submit">提交变更请求</button>
            </form>
        </div>
    </div>

    <!-- 评价模态框 -->
    <div id="rate-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">评价用户</h2>
                <button class="close-btn" onclick="closeModal('rate-modal')">&times;</button>
            </div>
            <form id="rate-form" onsubmit="submitRating(event)">
                <input type="hidden" name="tripId">
                <input type="hidden" name="toUserId">
                <div id="rate-user-name" style="margin-bottom: 16px; font-size: 16px; font-weight: 600;"></div>
                <div class="form-group rating-item">
                    <label>守时</label>
                    <div class="rating-stars" data-dimension="punctuality">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                    <input type="hidden" name="punctuality" value="0">
                </div>
                <div class="form-group rating-item">
                    <label>费用清晰</label>
                    <div class="rating-stars" data-dimension="costClarity">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                    <input type="hidden" name="costClarity" value="0">
                </div>
                <div class="form-group rating-item">
                    <label>沟通</label>
                    <div class="rating-stars" data-dimension="communication">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                    <input type="hidden" name="communication" value="0">
                </div>
                <div class="form-group rating-item">
                    <label>行程执行力</label>
                    <div class="rating-stars" data-dimension="planExecution">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                    <input type="hidden" name="planExecution" value="0">
                </div>
                <div class="form-group rating-item">
                    <label>边界感/安全感</label>
                    <div class="rating-stars" data-dimension="boundarySafety">
                        <span class="star" data-value="1">★</span>
                        <span class="star" data-value="2">★</span>
                        <span class="star" data-value="3">★</span>
                        <span class="star" data-value="4">★</span>
                        <span class="star" data-value="5">★</span>
                    </div>
                    <input type="hidden" name="boundarySafety" value="0">
                </div>
                <div class="form-group">
                    <label>文本评价（选填，限200字）</label>
                    <textarea name="text" maxlength="200"></textarea>
                </div>
                <button type="submit">提交评价</button>
            </form>
        </div>
    </div>

    <!-- 举报模态框 -->
    <div id="report-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">举报用户</h2>
                <button class="close-btn" onclick="closeModal('report-modal')">&times;</button>
            </div>
            <form id="report-form" onsubmit="submitReport(event)">
                <input type="hidden" name="tripId">
                <input type="hidden" name="toUserId">
                <div id="report-user-name" style="margin-bottom: 16px; font-size: 16px; font-weight: 600;"></div>
                <div class="form-group">
                    <label>举报类型 *</label>
                    <select name="type" required>
                        <option value="诈骗">诈骗</option>
                        <option value="骚扰">骚扰</option>
                        <option value="不当行为">不当行为</option>
                        <option value="临时加价">临时加价</option>
                        <option value="其他">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>详细说明（选填）</label>
                    <textarea name="text" maxlength="500"></textarea>
                </div>
                <button type="submit" class="danger">提交举报</button>
            </form>
        </div>
    </div>

    <script>
        // 常量定义
        const STORAGE_KEY = 'tripbuddy_v1';
        const STYLE_TAGS = ['特种兵', '慢游', '拍照党', '徒步', '逛吃', '早起', '夜猫', '博物馆', '自然风景', '小众', '酒吧', '购物'];
        const CONSTRAINTS = ['不夜生活', '不爬山', '不购物点', '不拼房', '拒绝临时改价'];
        const EXPENSE_TYPES = {
            TRANSPORT: '交通',
            LODGING: '住宿',
            FOOD: '餐饮',
            TICKET: '门票',
            OTHER: '其他'
        };
        const COST_MODES = {
            PURE_AA: '纯AA',
            HOST_BOOKING_AA: '代订+AA',
            SEPARATE_BOOKING: '各自预订'
        };

        // 全局状态
        let state = {
            currentUserId: 'u1',
            users: [],
            trips: []
        };

        // 初始化
        function init() {
            loadData();
            initStyleCheckboxes();
            initConstraintCheckboxes();
            updateUserSelect();
            renderTrips();
            initRatingStars();
        }

        // 初始化评分星星
        function initRatingStars() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('star')) {
                    const container = e.target.parentElement;
                    const dimension = container.dataset.dimension;
                    const value = parseInt(e.target.dataset.value);
                    const stars = container.querySelectorAll('.star');
                    stars.forEach((star, index) => {
                        if (index < value) {
                            star.classList.add('active');
                        } else {
                            star.classList.remove('active');
                        }
                    });
                    const input = container.nextElementSibling;
                    if (input && input.name === dimension) {
                        input.value = value;
                    }
                }
            });
        }

        // 加载数据
        function loadData() {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                state = JSON.parse(stored);
            } else {
                resetData();
            }
        }

        // 保存数据
        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        // 重置数据
        function resetData() {
            state = {
                currentUserId: 'u1',
                users: [
                    { id: 'u1', name: '阿林', verified: true, blacklist: [] },
                    { id: 'u2', name: '小周', verified: false, blacklist: [] },
                    { id: 'u3', name: 'Mika', verified: true, blacklist: [] }
                ],
                trips: [
                    {
                        id: 't1',
                        title: '杭州周末慢游',
                        from: '上海',
                        to: '杭州',
                        startDate: '2026-01-10',
                        endDate: '2026-01-12',
                        maxMembers: 4,
                        budgetTier: '舒适',
                        styleTags: ['慢游', '逛吃', '拍照党'],
                        constraints: ['拒绝临时改价'],
                        costMode: 'HOST_BOOKING_AA',
                        requireVerified: true,
                        hostUserId: 'u1',
                        status: 'RECRUITING',
                        memberIds: ['u1'],
                        applications: [
                            {
                                id: 'a1',
                                userId: 'u2',
                                answers: {
                                    budget: '舒适',
                                    pace: '慢游',
                                    schedule: '随缘',
                                    acceptable: ['AA'],
                                    concerns: ['临时加价']
                                },
                                intro: '喜欢拍照和美食',
                                status: 'PENDING'
                            }
                        ],
                        versions: [
                            {
                                id: 'v1',
                                number: 1,
                                content: {
                                    meetup: '上海虹桥火车站 9:00',
                                    lodging: '两人一间，费用AA',
                                    costRules: '门票、交通、餐饮各自负担后AA',
                                    cancelRule: '出发前3天取消全额退款'
                                },
                                createdAt: Date.now() - 86400000,
                                createdBy: 'u1'
                            }
                        ],
                        versionConfirmations: [
                            { versionId: 'v1', userId: 'u1', decision: 'AGREE', at: Date.now() - 86400000 }
                        ],
                        ledger: {
                            items: [
                                {
                                    id: 'e1',
                                    type: 'LODGING',
                                    title: '民宿两晚',
                                    amount: 800,
                                    paidBy: 'u1',
                                    split: 'EQUAL',
                                    participants: ['u1'],
                                    note: '订单留存',
                                    createdAt: Date.now() - 86400000,
                                    status: 'ACTIVE'
                                }
                            ],
                            changeRequests: []
                        },
                        ratings: [],
                        reports: []
                    },
                    {
                        id: 't2',
                        title: '北京周末文化游',
                        from: '天津',
                        to: '北京',
                        startDate: '2026-01-15',
                        endDate: '2026-01-17',
                        maxMembers: 3,
                        budgetTier: '经济',
                        styleTags: ['博物馆', '早起', '慢游'],
                        constraints: ['不夜生活'],
                        costMode: 'PURE_AA',
                        requireVerified: false,
                        hostUserId: 'u3',
                        status: 'RECRUITING',
                        memberIds: ['u3'],
                        applications: [],
                        versions: [
                            {
                                id: 'v2',
                                number: 1,
                                content: {
                                    meetup: '天津站 7:30',
                                    lodging: '青旅多人间',
                                    costRules: '纯AA，各付各的',
                                    cancelRule: '出发前5天取消免费'
                                },
                                createdAt: Date.now() - 172800000,
                                createdBy: 'u3'
                            }
                        ],
                        versionConfirmations: [
                            { versionId: 'v2', userId: 'u3', decision: 'AGREE', at: Date.now() - 172800000 }
                        ],
                        ledger: {
                            items: [],
                            changeRequests: []
                        },
                        ratings: [],
                        reports: []
                    }
                ]
            };
            saveData();
            alert('示例数据已重置');
            location.reload();
        }

        // 初始化风格标签
        function initStyleCheckboxes() {
            const filterStyles = document.getElementById('filter-styles');
            const createStyles = document.getElementById('create-styles');
            
            STYLE_TAGS.forEach(tag => {
                const filterItem = document.createElement('div');
                filterItem.className = 'checkbox-item';
                filterItem.innerHTML = `
                    <input type="checkbox" id="filter-style-${tag}" value="${tag}">
                    <label for="filter-style-${tag}" style="margin: 0;">${tag}</label>
                `;
                filterStyles.appendChild(filterItem);

                const createItem = document.createElement('div');
                createItem.className = 'checkbox-item';
                createItem.innerHTML = `
                    <input type="checkbox" name="styleTags" value="${tag}" id="create-style-${tag}">
                    <label for="create-style-${tag}" style="margin: 0;">${tag}</label>
                `;
                createStyles.appendChild(createItem);
            });
        }

        // 初始化硬约束
        function initConstraintCheckboxes() {
            const createConstraints = document.getElementById('create-constraints');
            CONSTRAINTS.forEach(constraint => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                item.innerHTML = `
                    <input type="checkbox" name="constraints" value="${constraint}" id="constraint-${constraint}">
                    <label for="constraint-${constraint}" style="margin: 0;">${constraint}</label>
                `;
                createConstraints.appendChild(item);
            });
        }

        // 更新用户选择
        function updateUserSelect() {
            const select = document.getElementById('userSelect');
            select.value = state.currentUserId;
        }

        // 切换用户
        function switchUser() {
            const select = document.getElementById('userSelect');
            state.currentUserId = select.value;
            saveData();
            renderCurrentView();
        }

        // 切换标签页
        function switchTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(`${tab}-view`).classList.add('active');

            renderCurrentView();
        }

        // 渲染当前视图
        function renderCurrentView() {
            const activeView = document.querySelector('.view.active');
            if (activeView.id === 'trips-view') {
                renderTrips();
            } else if (activeView.id === 'inbox-view') {
                renderInbox();
            } else if (activeView.id === 'profile-view') {
                renderProfile();
            }
        }

        // 应用筛选
        function applyFilters() {
            renderTrips();
        }

        // 渲染行程列表
        function renderTrips() {
            const container = document.getElementById('trip-list');
            const currentUser = getCurrentUser();
            
            // 获取筛选条件
            const destination = document.getElementById('filter-destination').value.toLowerCase();
            const startDate = document.getElementById('filter-start-date').value;
            const endDate = document.getElementById('filter-end-date').value;
            const budget = document.getElementById('filter-budget').value;
            const verifiedOnly = document.getElementById('filter-verified').checked;
            
            const selectedStyles = Array.from(document.querySelectorAll('#filter-styles input:checked'))
                .map(cb => cb.value);

            // 筛选行程
            let filtered = state.trips.filter(trip => {
                // 排除被当前用户拉黑的发起人的行程
                if (currentUser.blacklist.includes(trip.hostUserId)) {
                    return false;
                }
                
                if (destination && !trip.to.toLowerCase().includes(destination)) {
                    return false;
                }
                
                if (startDate && trip.startDate < startDate) {
                    return false;
                }
                
                if (endDate && trip.endDate > endDate) {
                    return false;
                }
                
                if (budget && trip.budgetTier !== budget) {
                    return false;
                }
                
                if (verifiedOnly && !trip.requireVerified) {
                    return false;
                }
                
                if (selectedStyles.length > 0) {
                    const hasStyle = selectedStyles.some(style => trip.styleTags.includes(style));
                    if (!hasStyle) return false;
                }
                
                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state">暂无符合条件的行程</div>';
                return;
            }

            container.innerHTML = filtered.map(trip => {
                const host = getUserById(trip.hostUserId);
                const vacancy = trip.maxMembers - trip.memberIds.length;
                
                return `
                    <div class="card trip-card" onclick="showTripDetail('${trip.id}')">
                        <div class="card-title">${trip.title}</div>
                        <div class="card-meta">
                            <div class="card-meta-item">📍 ${trip.from} → ${trip.to}</div>
                            <div class="card-meta-item">📅 ${trip.startDate} 至 ${trip.endDate}</div>
                            <div class="card-meta-item">👤 缺${vacancy}人</div>
                        </div>
                        <div class="tags">
                            <span class="tag budget">${trip.budgetTier}</span>
                            ${trip.styleTags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                        <div class="card-meta">
                            <div class="card-meta-item">💰 ${COST_MODES[trip.costMode]}</div>
                            ${trip.requireVerified ? '<div class="card-meta-item">✓ 需实名</div>' : ''}
                        </div>
                        <div style="margin-top: 8px; font-size: 14px; color: #718096;">
                            发起人: ${host.name}${host.verified ? ' ✓' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 显示行程详情
        function showTripDetail(tripId) {
            const trip = getTripById(tripId);
            if (!trip) return;

            const currentUser = getCurrentUser();
            const host = getUserById(trip.hostUserId);
            const isMember = trip.memberIds.includes(state.currentUserId);
            const isHost = trip.hostUserId === state.currentUserId;
            const latestVersion = trip.versions[trip.versions.length - 1];
            
            // 检查是否被拉黑
            const hostUser = getUserById(trip.hostUserId);
            const isBlacklisted = hostUser.blacklist.includes(state.currentUserId);

            let content = `
                <div class="detail-row">
                    <div class="detail-label">标题</div>
                    <div class="detail-value">${trip.title}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">路线</div>
                    <div class="detail-value">${trip.from} → ${trip.to}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">日期</div>
                    <div class="detail-value">${trip.startDate} 至 ${trip.endDate}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">预算档位</div>
                    <div class="detail-value">${trip.budgetTier}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">费用模式</div>
                    <div class="detail-value">${COST_MODES[trip.costMode]}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">风格标签</div>
                    <div class="detail-value">${trip.styleTags.join(', ')}</div>
                </div>
                ${trip.constraints.length > 0 ? `
                <div class="detail-row">
                    <div class="detail-label">硬约束</div>
                    <div class="detail-value">${trip.constraints.join(', ')}</div>
                </div>
                ` : ''}
                <div class="detail-row">
                    <div class="detail-label">安全要求</div>
                    <div class="detail-value">${trip.requireVerified ? '仅实名可申请' : '无限制'}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">状态</div>
                    <div class="detail-value">
                        <span class="status-badge status-${trip.status.toLowerCase()}">${getStatusText(trip.status)}</span>
                    </div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">发起人</div>
                    <div class="detail-value">${host.name}${host.verified ? ' ✓实名' : ''}</div>
                </div>
                <div class="detail-row">
                    <div class="detail-label">成员</div>
                    <div class="detail-value">${trip.memberIds.length} / ${trip.maxMembers}</div>
                </div>
                <div class="member-list">
                    ${trip.memberIds.map(userId => {
                        const user = getUserById(userId);
                        return `<span class="member-badge">${user.name}${user.verified ? ' ✓' : ''}</span>`;
                    }).join('')}
                </div>

                <hr class="section-divider">

                ${!isMember && trip.status === 'RECRUITING' ? `
                    <div class="action-buttons">
                        ${canApply(trip) ? `
                            <button onclick="openApplyModal('${trip.id}')">申请加入</button>
                        ` : `
                            ${!currentUser.verified && trip.requireVerified ? 
                                '<p style="color: #e53e3e;">此行程需要实名认证，请先在"我的"页面开启实名</p>' : ''}
                            ${isBlacklisted ? 
                                '<p style="color: #e53e3e;">你已被发起人限制，无法申请此行程</p>' : ''}
                            ${hasApplied(trip) ? 
                                '<p style="color: #f6ad55;">你已申请，等待审核中</p>' : ''}
                        `}
                    </div>
                ` : ''}

                ${isHost && trip.applications.filter(a => a.status === 'PENDING').length > 0 ? `
                    <h3>待审核申请</h3>
                    ${trip.applications.filter(a => a.status === 'PENDING').map(app => {
                        const applicant = getUserById(app.userId);
                        return `
                            <div class="application-item">
                                <div class="application-header">
                                    <strong>${applicant.name}${applicant.verified ? ' ✓' : ''}</strong>
                                    <div class="application-actions">
                                        <button onclick="approveApplication('${trip.id}', '${app.id}')">通过</button>
                                        <button onclick="rejectApplication('${trip.id}', '${app.id}')" class="danger">拒绝</button>
                                    </div>
                                </div>
                                <div style="font-size: 14px; color: #4a5568;">
                                    <p>预算: ${app.answers.budget} | 节奏: ${app.answers.pace} | 作息: ${app.answers.schedule}</p>
                                    <p>可接受: ${app.answers.acceptable.join(', ') || '无'}</p>
                                    <p>最介意: ${app.answers.concerns.join(', ') || '无'}</p>
                                    ${app.intro ? `<p>介绍: ${app.intro}</p>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('')}
                ` : ''}

                ${isMember ? `
                    <hr class="section-divider">
                    <h3>行程版本</h3>
                    <div style="margin-bottom: 12px;">
                        当前版本: V${latestVersion.number}
                        ${isAllConfirmed(trip, latestVersion.id) ? 
                            '<span class="status-badge status-confirmed" style="margin-left: 8px;">已全员确认</span>' : 
                            '<span class="status-badge status-pending" style="margin-left: 8px;">待确认</span>'}
                    </div>
                    
                    ${trip.versions.slice().reverse().map(version => {
                        const creator = getUserById(version.createdBy);
                        const confirmations = trip.versionConfirmations.filter(c => c.versionId === version.id);
                        const myConfirmation = confirmations.find(c => c.userId === state.currentUserId);
                        
                        return `
                            <div class="version-item">
                                <div class="version-header">
                                    <strong>V${version.number}</strong>
                                    <span style="font-size: 12px; color: #718096;">
                                        ${formatDate(version.createdAt)} by ${creator.name}
                                    </span>
                                </div>
                                <div class="version-content">
                                    <p><strong>集合:</strong> ${version.content.meetup}</p>
                                    <p><strong>住宿:</strong> ${version.content.lodging}</p>
                                    <p><strong>费用:</strong> ${version.content.costRules}</p>
                                    <p><strong>取消:</strong> ${version.content.cancelRule}</p>
                                </div>
                                <div class="confirmation-list">
                                    ${trip.memberIds.map(userId => {
                                        const user = getUserById(userId);
                                        const conf = confirmations.find(c => c.userId === userId);
                                        const status = conf ? conf.decision : 'PENDING';
                                        return `
                                            <span class="confirmation-item ${status.toLowerCase()}">
                                                ${user.name}: ${status === 'AGREE' ? '✓同意' : status === 'DISAGREE' ? '✗不同意' : '待确认'}
                                            </span>
                                        `;
                                    }).join('')}
                                </div>
                                ${version.id === latestVersion.id && !myConfirmation && isMember ? `
                                    <div style="margin-top: 12px;">
                                        <button onclick="confirmVersion('${trip.id}', '${version.id}', 'AGREE')">同意此版本</button>
                                        <button onclick="confirmVersion('${trip.id}', '${version.id}', 'DISAGREE')" class="danger">不同意</button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                    
                    ${isHost ? `
                        <button onclick="openNewVersionModal('${trip.id}')" style="margin-top: 12px;">发布新版本</button>
                    ` : ''}

                    <div class="collapsible">
                        <div class="collapsible-header" onclick="toggleCollapsible(this)">
                            <h3>账本 Ledger</h3>
                            <span>▼</span>
                        </div>
                        <div class="collapsible-content">
                            ${renderLedger(trip)}
                        </div>
                    </div>
                ` : ''}

                ${isMember && trip.status === 'FINISHED' ? `
                    <hr class="section-divider">
                    <h3>评价与举报</h3>
                    <div class="action-buttons">
                        ${trip.memberIds.filter(id => id !== state.currentUserId).map(userId => {
                            const user = getUserById(userId);
                            const hasRated = trip.ratings.some(r => r.fromUserId === state.currentUserId && r.toUserId === userId);
                            return `
                                <button onclick="openRateModal('${trip.id}', '${userId}')" ${hasRated ? 'disabled' : ''}>
                                    评价 ${user.name} ${hasRated ? '(已评价)' : ''}
                                </button>
                                <button onclick="openReportModal('${trip.id}', '${userId}')" class="danger">举报 ${user.name}</button>
                                <button onclick="blacklistUser('${userId}')" class="secondary">拉黑 ${user.name}</button>
                            `;
                        }).join('')}
                    </div>
                ` : ''}

                ${isHost && trip.status !== 'FINISHED' ? `
                    <hr class="section-divider">
                    <button onclick="finishTrip('${trip.id}')" class="secondary">标记行程已结束</button>
                ` : ''}
            `;

            document.getElementById('trip-detail-content').innerHTML = content;
            openModal('trip-detail-modal');
        }

        // 切换折叠
        function toggleCollapsible(header) {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('span');
            content.classList.toggle('active');
            arrow.textContent = content.classList.contains('active') ? '▲' : '▼';
        }

        // 渲染账本
        function renderLedger(trip) {
            const settlement = calculateSettlement(trip);
            
            let html = `
                <button onclick="openAddExpenseModal('${trip.id}')">新增费用</button>
                
                <h4 style="margin-top: 24px;">费用条目</h4>
                ${trip.ledger.items.length === 0 ? 
                    '<div class="empty-state" style="padding: 20px;">暂无费用</div>' :
                    trip.ledger.items.map(item => {
                        const payer = getUserById(item.paidBy);
                        return `
                            <div class="ledger-item">
                                <div class="ledger-header">
                                    <div>
                                        <strong>${item.title}</strong>
                                        <span class="tag" style="margin-left: 8px;">${EXPENSE_TYPES[item.type]}</span>
                                    </div>
                                    <div style="font-weight: 600;">¥${item.amount}</div>
                                </div>
                                <div style="font-size: 14px; color: #4a5568; margin-top: 8px;">
                                    <p>付款人: ${payer.name} | 分摊: ${item.split === 'EQUAL' ? '均分' : '自定义'}</p>
                                    <p>参与者: ${item.participants.map(id => getUserById(id).name).join(', ')}</p>
                                    ${item.note ? `<p>备注: ${item.note}</p>` : ''}
                                    <p style="font-size: 12px; color: #718096;">${formatDate(item.createdAt)}</p>
                                </div>
                                ${item.status === 'ACTIVE' ? `
                                    <div style="margin-top: 8px;">
                                        <button onclick="editExpenseItem('${trip.id}', '${item.id}')" class="secondary">编辑</button>
                                        <button onclick="deleteExpenseItem('${trip.id}', '${item.id}')" class="danger">删除</button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')
                }

                ${trip.ledger.changeRequests.length > 0 ? `
                    <h4 style="margin-top: 24px;">费用变更请求</h4>
                    ${trip.ledger.changeRequests.map(cr => {
                        const myApproval = cr.approvals.find(a => a.userId === state.currentUserId);
                        const allApprovals = cr.approvals.filter(a => a.decision === 'AGREE').length;
                        const needApprovals = trip.memberIds.length;
                        
                        return `
                            <div class="ledger-item" style="border-left-color: #f6ad55;">
                                <div class="ledger-header">
                                    <div>
                                        <strong>${cr.action === 'UPDATE' ? '编辑' : '删除'}费用</strong>
                                        <span class="status-badge status-${cr.status.toLowerCase()}" style="margin-left: 8px;">
                                            ${cr.status === 'PENDING' ? '待确认' : cr.status === 'APPROVED' ? '已通过' : '已拒绝'}
                                        </span>
                                    </div>
                                </div>
                                ${cr.action === 'UPDATE' && cr.proposedItem ? `
                                    <div style="font-size: 14px; color: #4a5568; margin-top: 8px;">
                                        <p>新标题: ${cr.proposedItem.title} | 新金额: ¥${cr.proposedItem.amount}</p>
                                    </div>
                                ` : ''}
                                <div style="margin-top: 8px; font-size: 13px;">
                                    已同意: ${allApprovals} / ${needApprovals}
                                </div>
                                ${!myApproval && cr.status === 'PENDING' ? `
                                    <div style="margin-top: 8px;">
                                        <button onclick="approveChangeRequest('${trip.id}', '${cr.id}', 'AGREE')">同意</button>
                                        <button onclick="approveChangeRequest('${trip.id}', '${cr.id}', 'DISAGREE')" class="danger">不同意</button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                ` : ''}

                <h4 style="margin-top: 24px;">结算</h4>
                <table class="settlement-table">
                    <thead>
                        <tr>
                            <th>成员</th>
                            <th>已付</th>
                            <th>应付</th>
                            <th>净额</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(settlement).map(([userId, data]) => {
                            const user = getUserById(userId);
                            return `
                                <tr>
                                    <td>${user.name}</td>
                                    <td>¥${data.paid.toFixed(2)}</td>
                                    <td>¥${data.owed.toFixed(2)}</td>
                                    <td class="${data.net >= 0 ? 'amount-positive' : 'amount-negative'}">
                                        ${data.net >= 0 ? '+' : ''}¥${data.net.toFixed(2)}
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            return html;
        }

        // 计算结算
        function calculateSettlement(trip) {
            const settlement = {};
            trip.memberIds.forEach(userId => {
                settlement[userId] = { paid: 0, owed: 0, net: 0 };
            });

            trip.ledger.items.filter(item => item.status === 'ACTIVE').forEach(item => {
                // 记录已付
                settlement[item.paidBy].paid += item.amount;
                
                // 计算应付
                if (item.split === 'EQUAL' && item.participants.length > 0) {
                    const perPerson = item.amount / item.participants.length;
                    item.participants.forEach(userId => {
                        settlement[userId].owed += perPerson;
                    });
                }
            });

            // 计算净额
            Object.keys(settlement).forEach(userId => {
                settlement[userId].net = settlement[userId].paid - settlement[userId].owed;
            });

            return settlement;
        }

        // 打开申请模态框
        function openApplyModal(tripId) {
            document.querySelector('#apply-form input[name="tripId"]').value = tripId;
            openModal('apply-modal');
        }

        // 提交申请
        function submitApplication(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const tripId = formData.get('tripId');
            const trip = getTripById(tripId);

            const acceptable = [];
            const concerns = [];
            
            formData.getAll('acceptable').forEach(val => acceptable.push(val));
            formData.getAll('concerns').forEach(val => concerns.push(val));

            const application = {
                id: 'a' + Date.now(),
                userId: state.currentUserId,
                answers: {
                    budget: formData.get('budget'),
                    pace: formData.get('pace'),
                    schedule: formData.get('schedule'),
                    acceptable: acceptable,
                    concerns: concerns
                },
                intro: formData.get('intro'),
                status: 'PENDING'
            };

            trip.applications.push(application);
            saveData();
            closeModal('apply-modal');
            alert('申请已提交');
            showTripDetail(tripId);
        }

        // 审核申请
        function approveApplication(tripId, appId) {
            const trip = getTripById(tripId);
            const app = trip.applications.find(a => a.id === appId);
            
            app.status = 'APPROVED';
            trip.memberIds.push(app.userId);
            
            // 对最新版本设置为未确认
            const latestVersion = trip.versions[trip.versions.length - 1];
            trip.versionConfirmations = trip.versionConfirmations.filter(
                c => !(c.versionId === latestVersion.id && c.userId === app.userId)
            );
            
            saveData();
            alert('已通过申请');
            showTripDetail(tripId);
        }

        function rejectApplication(tripId, appId) {
            const trip = getTripById(tripId);
            const app = trip.applications.find(a => a.id === appId);
            app.status = 'REJECTED';
            saveData();
            alert('已拒绝申请');
            showTripDetail(tripId);
        }

        // 打开新版本模态框
        function openNewVersionModal(tripId) {
            const trip = getTripById(tripId);
            const latestVersion = trip.versions[trip.versions.length - 1];
            
            const form = document.getElementById('new-version-form');
            form.querySelector('input[name="tripId"]').value = tripId;
            form.querySelector('input[name="meetup"]').value = latestVersion.content.meetup;
            form.querySelector('textarea[name="lodging"]').value = latestVersion.content.lodging;
            form.querySelector('textarea[name="costRules"]').value = latestVersion.content.costRules;
            form.querySelector('textarea[name="cancelRule"]').value = latestVersion.content.cancelRule;
            
            openModal('new-version-modal');
        }

        // 发布新版本
        function publishNewVersion(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const tripId = formData.get('tripId');
            const trip = getTripById(tripId);
            
            const newVersion = {
                id: 'v' + Date.now(),
                number: trip.versions.length + 1,
                content: {
                    meetup: formData.get('meetup'),
                    lodging: formData.get('lodging'),
                    costRules: formData.get('costRules'),
                    cancelRule: formData.get('cancelRule')
                },
                createdAt: Date.now(),
                createdBy: state.currentUserId
            };
            
            trip.versions.push(newVersion);
            
            // 重置所有成员的确认状态
            trip.versionConfirmations = trip.versionConfirmations.filter(
                c => c.versionId !== newVersion.id
            );
            
            saveData();
            closeModal('new-version-modal');
            alert('新版本已发布');
            showTripDetail(tripId);
        }

        // 确认版本
        function confirmVersion(tripId, versionId, decision) {
            const trip = getTripById(tripId);
            
            trip.versionConfirmations = trip.versionConfirmations.filter(
                c => !(c.versionId === versionId && c.userId === state.currentUserId)
            );
            
            trip.versionConfirmations.push({
                versionId: versionId,
                userId: state.currentUserId,
                decision: decision,
                at: Date.now()
            });
            
            saveData();
            alert(decision === 'AGREE' ? '已同意此版本' : '已表示不同意');
            showTripDetail(tripId);
        }

        // 检查是否全员确认
        function isAllConfirmed(trip, versionId) {
            const confirmations = trip.versionConfirmations.filter(c => c.versionId === versionId);
            return trip.memberIds.every(userId => {
                const conf = confirmations.find(c => c.userId === userId);
                return conf && conf.decision === 'AGREE';
            });
        }

        // 打开新增费用模态框
        function openAddExpenseModal(tripId) {
            const trip = getTripById(tripId);
            const form = document.getElementById('add-expense-form');
            form.querySelector('input[name="tripId"]').value = tripId;
            
            // 填充付款人
            const paidBySelect = document.getElementById('expense-paidby');
            paidBySelect.innerHTML = trip.memberIds.map(userId => {
                const user = getUserById(userId);
                return `<option value="${userId}">${user.name}</option>`;
            }).join('');
            
            // 填充参与者
            const participantsDiv = document.getElementById('expense-participants');
            participantsDiv.innerHTML = trip.memberIds.map(userId => {
                const user = getUserById(userId);
                return `
                    <div class="checkbox-item">
                        <input type="checkbox" name="participants" value="${userId}" id="exp-part-${userId}" checked>
                        <label for="exp-part-${userId}" style="margin: 0;">${user.name}</label>
                    </div>
                `;
            }).join('');
            
            openModal('add-expense-modal');
        }

        // 新增费用
        function addExpense(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const tripId = formData.get('tripId');
            const trip = getTripById(tripId);
            
            const participants = formData.getAll('participants');
            
            const item = {
                id: 'e' + Date.now(),
                type: formData.get('type'),
                title: formData.get('title'),
                amount: parseFloat(formData.get('amount')),
                paidBy: formData.get('paidBy'),
                split: formData.get('split'),
                participants: participants,
                note: formData.get('note'),
                createdAt: Date.now(),
                status: 'ACTIVE'
            };
            
            trip.ledger.items.push(item);
            saveData();
            closeModal('add-expense-modal');
            alert('费用已添加');
            showTripDetail(tripId);
        }

        // 编辑费用
        function editExpenseItem(tripId, itemId) {
            const trip = getTripById(tripId);
            const item = trip.ledger.items.find(i => i.id === itemId);
            
            const form = document.getElementById('edit-expense-form');
            form.querySelector('input[name="tripId"]').value = tripId;
            form.querySelector('input[name="itemId"]').value = itemId;
            form.querySelector('select[name="type"]').value = item.type;
            form.querySelector('input[name="title"]').value = item.title;
            form.querySelector('input[name="amount"]').value = item.amount;
            form.querySelector('textarea[name="note"]').value = item.note;
            
            // 填充付款人
            const paidBySelect = document.getElementById('edit-expense-paidby');
            paidBySelect.innerHTML = trip.memberIds.map(userId => {
                const user = getUserById(userId);
                return `<option value="${userId}" ${userId === item.paidBy ? 'selected' : ''}>${user.name}</option>`;
            }).join('');
            
            // 填充参与者
            const participantsDiv = document.getElementById('edit-expense-participants');
            participantsDiv.innerHTML = trip.memberIds.map(userId => {
                const user = getUserById(userId);
                const checked = item.participants.includes(userId);
                return `
                    <div class="checkbox-item">
                        <input type="checkbox" name="participants" value="${userId}" id="edit-exp-part-${userId}" ${checked ? 'checked' : ''}>
                        <label for="edit-exp-part-${userId}" style="margin: 0;">${user.name}</label>
                    </div>
                `;
            }).join('');
            
            openModal('edit-expense-modal');
        }

        // 删除费用
        function deleteExpenseItem(tripId, itemId) {
            if (!confirm('确定要删除此费用吗？需要所有成员确认。')) return;
            
            const trip = getTripById(tripId);
            const changeRequest = {
                id: 'cr' + Date.now(),
                itemId: itemId,
                action: 'DELETE',
                approvals: [{
                    userId: state.currentUserId,
                    decision: 'AGREE',
                    at: Date.now()
                }],
                status: 'PENDING',
                createdAt: Date.now()
            };
            
            trip.ledger.changeRequests.push(changeRequest);
            saveData();
            alert('删除请求已创建，等待其他成员确认');
            showTripDetail(tripId);
        }

        // 提交费用变更
        function submitExpenseChange(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const tripId = formData.get('tripId');
            const itemId = formData.get('itemId');
            const trip = getTripById(tripId);
            
            const participants = formData.getAll('participants');
            
            const proposedItem = {
                id: itemId,
                type: formData.get('type'),
                title: formData.get('title'),
                amount: parseFloat(formData.get('amount')),
                paidBy: formData.get('paidBy'),
                split: formData.get('split'),
                participants: participants,
                note: formData.get('note'),
                status: 'ACTIVE'
            };
            
            const changeRequest = {
                id: 'cr' + Date.now(),
                itemId: itemId,
                action: 'UPDATE',
                proposedItem: proposedItem,
                approvals: [{
                    userId: state.currentUserId,
                    decision: 'AGREE',
                    at: Date.now()
                }],
                status: 'PENDING',
                createdAt: Date.now()
            };
            
            trip.ledger.changeRequests.push(changeRequest);
            saveData();
            closeModal('edit-expense-modal');
            alert('变更请求已创建，等待其他成员确认');
            showTripDetail(tripId);
        }

        // 审批费用变更
        function approveChangeRequest(tripId, crId, decision) {
            const trip = getTripById(tripId);
            const cr = trip.ledger.changeRequests.find(r => r.id === crId);
            
            // 添加审批
            cr.approvals.push({
                userId: state.currentUserId,
                decision: decision,
                at: Date.now()
            });
            
            // 检查是否所有人都同意
            const allAgree = trip.memberIds.every(userId => {
                const approval = cr.approvals.find(a => a.userId === userId);
                return approval && approval.decision === 'AGREE';
            });
            
            const anyDisagree = cr.approvals.some(a => a.decision === 'DISAGREE');
            
            if (anyDisagree) {
                cr.status = 'REJECTED';
            } else if (allAgree) {
                cr.status = 'APPROVED';
                
                // 执行变更
                if (cr.action === 'UPDATE') {
                    const item = trip.ledger.items.find(i => i.id === cr.itemId);
                    Object.assign(item, cr.proposedItem);
                } else if (cr.action === 'DELETE') {
                    trip.ledger.items = trip.ledger.items.filter(i => i.id !== cr.itemId);
                }
            }
            
            saveData();
            alert(decision === 'AGREE' ? '已同意变更' : '已拒绝变更');
            showTripDetail(tripId);
        }

        // 结束行程
        function finishTrip(tripId) {
            if (!confirm('确定要标记行程已结束吗？')) return;
            
            const trip = getTripById(tripId);
            trip.status = 'FINISHED';
            saveData();
            alert('行程已标记为结束');
            showTripDetail(tripId);
        }

        // 打开评价模态框
        function openRateModal(tripId, toUserId) {
            const user = getUserById(toUserId);
            document.getElementById('rate-user-name').textContent = `评价 ${user.name}`;
            document.querySelector('#rate-form input[name="tripId"]').value = tripId;
            document.querySelector('#rate-form input[name="toUserId"]').value = toUserId;
            
            // 重置星星
            document.querySelectorAll('.rating-stars .star').forEach(star => {
                star.classList.remove('active');
            });
            document.querySelectorAll('#rate-form input[type="hidden"]').forEach(input => {
                if (input.name !== 'tripId' && input.name !== 'toUserId') {
                    input.value = '0';
                }
            });
            
            openModal('rate-modal');
        }

        // 提交评价
        function submitRating(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const tripId = formData.get('tripId');
            const trip = getTripById(tripId);
            
            const scores = {
                punctuality: parseInt(formData.get('punctuality')),
                costClarity: parseInt(formData.get('costClarity')),
                communication: parseInt(formData.get('communication')),
                planExecution: parseInt(formData.get('planExecution')),
                boundarySafety: parseInt(formData.get('boundarySafety'))
            };
            
            // 验证
            if (Object.values(scores).some(s => s === 0)) {
                alert('请为所有维度评分');
                return;
            }
            
            const rating = {
                fromUserId: state.currentUserId,
                toUserId: formData.get('toUserId'),
                tripId: tripId,
                scores: scores,
                text: formData.get('text'),
                createdAt: Date.now()
            };
            
            // 删除之前的评价（如果有）
            trip.ratings = trip.ratings.filter(
                r => !(r.fromUserId === state.currentUserId && r.toUserId === rating.toUserId)
            );
            
            trip.ratings.push(rating);
            saveData();
            closeModal('rate-modal');
            alert('评价已提交');
            showTripDetail(tripId);
        }

        // 打开举报模态框
        function openReportModal(tripId, toUserId) {
            const user = getUserById(toUserId);
            document.getElementById('report-user-name').textContent = `举报 ${user.name}`;
            document.querySelector('#report-form input[name="tripId"]').value = tripId;
            document.querySelector('#report-form input[name="toUserId"]').value = toUserId;
            openModal('report-modal');
        }

        // 提交举报
        function submitReport(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const tripId = formData.get('tripId');
            const trip = getTripById(tripId);
            
            const report = {
                fromUserId: state.currentUserId,
                toUserId: formData.get('toUserId'),
                tripId: tripId,
                type: formData.get('type'),
                text: formData.get('text'),
                createdAt: Date.now()
            };
            
            trip.reports.push(report);
            saveData();
            closeModal('report-modal');
            alert('举报已提交');
        }

        // 拉黑用户
        function blacklistUser(userId) {
            if (!confirm('确定要拉黑此用户吗？')) return;
            
            const currentUser = getCurrentUser();
            if (!currentUser.blacklist.includes(userId)) {
                currentUser.blacklist.push(userId);
                saveData();
                alert('已拉黑');
                renderCurrentView();
            }
        }

        // 移除黑名单
        function removeFromBlacklist(userId) {
            const currentUser = getCurrentUser();
            currentUser.blacklist = currentUser.blacklist.filter(id => id !== userId);
            saveData();
            renderProfile();
        }

        // 创建行程
        function createTrip(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            // 验证日期
            const startDate = formData.get('startDate');
            const endDate = formData.get('endDate');
            if (endDate < startDate) {
                alert('结束日期不能早于开始日期');
                return;
            }
            
            const maxMembers = parseInt(formData.get('maxMembers'));
            if (maxMembers < 2) {
                alert('人数上限至少为2人');
                return;
            }
            
            const styleTags = formData.getAll('styleTags');
            const constraints = formData.getAll('constraints');
            
            const trip = {
                id: 't' + Date.now(),
                title: formData.get('title'),
                from: formData.get('from'),
                to: formData.get('to'),
                startDate: startDate,
                endDate: endDate,
                maxMembers: maxMembers,
                budgetTier: formData.get('budgetTier'),
                styleTags: styleTags,
                constraints: constraints,
                costMode: formData.get('costMode'),
                requireVerified: formData.get('requireVerified') === 'on',
                hostUserId: state.currentUserId,
                status: 'RECRUITING',
                memberIds: [state.currentUserId],
                applications: [],
                versions: [{
                    id: 'v' + Date.now(),
                    number: 1,
                    content: {
                        meetup: formData.get('meetup') || '',
                        lodging: formData.get('lodging') || '',
                        costRules: formData.get('costRules') || '',
                        cancelRule: formData.get('cancelRule') || ''
                    },
                    createdAt: Date.now(),
                    createdBy: state.currentUserId
                }],
                versionConfirmations: [{
                    versionId: 'v' + Date.now(),
                    userId: state.currentUserId,
                    decision: 'AGREE',
                    at: Date.now()
                }],
                ledger: {
                    items: [],
                    changeRequests: []
                },
                ratings: [],
                reports: []
            };
            
            state.trips.push(trip);
            saveData();
            e.target.reset();
            alert('行程已发布');
            showTripDetail(trip.id);
        }

        // 渲染收件箱
        function renderInbox() {
            const container = document.getElementById('inbox-list');
            const items = [];
            
            // 我发起的行程的待审核申请
            state.trips.filter(t => t.hostUserId === state.currentUserId).forEach(trip => {
                const pendingApps = trip.applications.filter(a => a.status === 'PENDING');
                pendingApps.forEach(app => {
                    const applicant = getUserById(app.userId);
                    items.push({
                        type: 'application',
                        text: `${applicant.name} 申请加入「${trip.title}」`,
                        onClick: () => showTripDetail(trip.id)
                    });
                });
            });
            
            // 我加入的行程的版本确认
            state.trips.filter(t => t.memberIds.includes(state.currentUserId)).forEach(trip => {
                const latestVersion = trip.versions[trip.versions.length - 1];
                const myConfirmation = trip.versionConfirmations.find(
                    c => c.versionId === latestVersion.id && c.userId === state.currentUserId
                );
                
                if (!myConfirmation) {
                    items.push({
                        type: 'version',
                        text: `「${trip.title}」有新版本(V${latestVersion.number})需要确认`,
                        onClick: () => showTripDetail(trip.id)
                    });
                }
            });
            
            // 我加入的行程的费用变更请求
            state.trips.filter(t => t.memberIds.includes(state.currentUserId)).forEach(trip => {
                trip.ledger.changeRequests.filter(cr => cr.status === 'PENDING').forEach(cr => {
                    const myApproval = cr.approvals.find(a => a.userId === state.currentUserId);
                    if (!myApproval) {
                        items.push({
                            type: 'change',
                            text: `「${trip.title}」有费用${cr.action === 'UPDATE' ? '编辑' : '删除'}请求需要确认`,
                            onClick: () => showTripDetail(trip.id)
                        });
                    }
                });
            });
            
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-state">暂无待办事项</div>';
                return;
            }
            
            container.innerHTML = items.map(item => `
                <div class="inbox-item" onclick='${item.onClick.toString().match(/showTripDetail\('(.+?)'\)/)[0]}'>
                    ${item.text}
                </div>
            `).join('');
        }

        // 渲染个人资料
        function renderProfile() {
            const currentUser = getCurrentUser();
            const infoDiv = document.getElementById('profile-info');
            
            infoDiv.innerHTML = `
                <div class="profile-section">
                    <div class="detail-row">
                        <div class="detail-label">姓名</div>
                        <div class="detail-value">${currentUser.name}</div>
                    </div>
                    <div class="detail-row">
                        <div class="detail-label">实名状态</div>
                        <div class="detail-value">
                            <label>
                                <input type="checkbox" ${currentUser.verified ? 'checked' : ''} 
                                    onchange="toggleVerified()">
                                ${currentUser.verified ? '已实名' : '未实名'}
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="profile-section">
                    <h3>黑名单</h3>
                    ${currentUser.blacklist.length === 0 ? 
                        '<div class="empty-state" style="padding: 20px;">黑名单为空</div>' :
                        currentUser.blacklist.map(userId => {
                            const user = getUserById(userId);
                            return `
                                <div class="blacklist-item">
                                    <span>${user.name}</span>
                                    <button onclick="removeFromBlacklist('${userId}')" class="danger">移除</button>
                                </div>
                            `;
                        }).join('')
                    }
                </div>
            `;
            
            // 我的行程
            const myTripsDiv = document.getElementById('my-trips');
            const myTrips = state.trips.filter(t => 
                t.hostUserId === state.currentUserId || t.memberIds.includes(state.currentUserId)
            );
            
            if (myTrips.length === 0) {
                myTripsDiv.innerHTML = '<div class="empty-state">暂无行程</div>';
                return;
            }
            
            myTripsDiv.innerHTML = myTrips.map(trip => {
                const role = trip.hostUserId === state.currentUserId ? '发起人' : '成员';
                return `
                    <div class="card trip-card" onclick="showTripDetail('${trip.id}')">
                        <div class="card-title">${trip.title}</div>
                        <div class="card-meta">
                            <div class="card-meta-item">身份: ${role}</div>
                            <div class="card-meta-item">
                                <span class="status-badge status-${trip.status.toLowerCase()}">${getStatusText(trip.status)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 切换实名状态
        function toggleVerified() {
            const currentUser = getCurrentUser();
            currentUser.verified = !currentUser.verified;
            saveData();
            renderProfile();
        }

        // 辅助函数
        function getCurrentUser() {
            return state.users.find(u => u.id === state.currentUserId);
        }

        function getUserById(userId) {
            return state.users.find(u => u.id === userId);
        }

        function getTripById(tripId) {
            return state.trips.find(t => t.id === tripId);
        }

        function canApply(trip) {
            const currentUser = getCurrentUser();
            const hostUser = getUserById(trip.hostUserId);
            
            if (trip.requireVerified && !currentUser.verified) return false;
            if (hostUser.blacklist.includes(state.currentUserId)) return false;
            if (hasApplied(trip)) return false;
            if (trip.memberIds.includes(state.currentUserId)) return false;
            
            return true;
        }

        function hasApplied(trip) {
            return trip.applications.some(a => 
                a.userId === state.currentUserId && a.status === 'PENDING'
            );
        }

        function getStatusText(status) {
            const map = {
                RECRUITING: '招募中',
                CONFIRMED: '已确认',
                FINISHED: '已结束'
            };
            return map[status] || status;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // 点击模态框背景关闭
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                closeModal(e.target.id);
            }
        });

        // 初始化应用
        init();
    </script>
</body>
</html>